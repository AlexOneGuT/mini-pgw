# MiniPGW

Проект **Mini-PGW** — это примитивная версия узла Packet Gateway (PGW) кластера EPC.
Моя версия умеет обрабатывать UDP-запросы, предоставлять HTTP API, управлять сессиями абонентов на основе IMSI (International Mobile Subscriber Identity), 
вести логгирование на важных этапах управления сервером и сессиями абонентов, загружать конфигурацию из файлов с расширением .json.

---

## На чем построен проект?

- Linux OC
- C++ 20
- **Зависимости** (автоматически управляются через CMake):
  - `cpp-httplib` (HTTP-сервер).
  - `nlohmann_json` (Для парсинга JSON).
  - `googletest` (Для тестирования).
  - `spdlog` (Для логгирования).

---

##  Кластер проекта

### Сервер (`pgw_server`)
- Принимает UDP-запросы, содержащие IMSI в формате BCD-строк.
- Создаёт или отклоняет сессии абонентов на основе чёрного списка IMSI или по причине существующей сессии.
- Управляет сессиями с настраиваемыми таймаутами.
- Записывает события сессий и состояние работы сервера в log-файлы.
- Предоставляет HTTP API c возможностью проверить состояние сессии абонента, остановить работу сервера, динамически обновить конфигурацию сервера.

### Клиент (`pgw_client`)
- Отправляет UDP-запросы с указанным IMSI на сервер.
- Получает и отображает ответ сервера (например, "created", "rejected", "rejected_duplicate").

---

## Сборка проекта

Запустите скрипт 'build.sh', который соберет проект, а также автоматически создат скрипт для запуска сервера.

---

## Как запустить сервер?

### Структура файла конфигурации server_config.json.

Файлы с конфигурацией находятся в директории configs, конфигурационный файл сервера называется - server_config.json.

### Пример `config_server.json` по умолчанию
```
{
  "udp_ip": "127.0.0.1",
  "udp_port": 9001,
  "session_timeout_sec": 30,
  "cdr_file": "logs/cdr.log",
  "http_port": 8080,
  "graceful_shutdown_rate": 1,
  "log_file": "logs/pgw.log",
  "log_level": "info",
  "blacklist": ["111111111111111", "222222222222222"]
}
```
### Запуск сервера

Чтобы запустить сервер запустите скрипт 'start' или выполните ./build/pgw_server из родительской проекта.

---

## Как запустить клиент?

Файлы с конфигурацией находятся в директории configs, конфигурационный файл сервера называется - client_config.json.

### Пример `config_client.json` по умолчанию
```json
{
  "server_ip": "127.0.0.1",
  "server_port": 9001,
  "log_file": "logs/client.log",
  "log_level": "INFO"
}
```
### Запуск клиента

Чтобы запустить клиент выполните ./build/pgw_client <IMSI> из родительской проекта.

### Ps.

Длинна IMSI по документации может достигать максимум 15-значного размера, 
и имеет формат MСC(Код страны - 3 цифры)+MNC(Код оператора 2-3 цифры)+MSIN(Идентификационный номер мобильной подписки - Обычно составляющий 9-10 цифр).
То есть на практике IMSI по длинне может варироваться в пределах 13-15 значений, в этом проекте нижний предел длинны IMSI составляет 10 значений.
И клиент и сервер не пропустят пакеты с IMSI длинной меньше 10.

---

## Как использовать HTTP API?

1. **Запрос статуса сессии абонента**:
   ```bash
   curl http://localhost:8080/check_subscriber?imsi=<IMSI>
   ```
   - Возвращает `"active"`, если есть активная сессия на указанный IMSI и `"not active"` в противоположном случае.
   - Пример: `curl http://localhost:8080/check_subscriber?imsi=001010123456789`

2. **Завершение работы**:
   ```bash
   curl http://localhost:8080/stop
   ```
   - Завершает работу сервера, удаляя сессии с заданной скоростью

3. **Динамическое обновление сервера**
	```bash
	curl http://localhost:8080/reload_config
	```
	- Сервер поддерживает динамическое изменение конфигурации в секциях blacklist и log_level! 
	- Перед использованием обновите в конфигурационном файле нужные параметры!
	- Динамически обновляет конфигураци сервера, без его остановки
---

## Будем тестить? 

В директории `build/tests/`. После сборки запустите их с помощью следующих команд:

```bash
./tests/test_bcd                 # Тесты конвертации IMSI в BCD
./tests/test_config		 # Тесты загрузки конфигурации
./tests/test_server		 # Тесты сервера
./tests/test_server_api		 # Тесты HTTP-API
./tests/test_client_integration  # Тесты UDP-взаимодействия клиента
./tests/test_session		 # Тесты управления сессиями
```

Или введите `ctest` из директории `tests` для запуска всех тестов.

---

## Логирование

- **Логи сервера**: Записываются в `pgw.log` (настройка в `config_server.json`).
- **Логи клиента**: Записываются в `client.log` (настройка в `config_client.json`).
- **Журнал CDR**: События сессий (создание, удаление, завершение) записываются в `cdr.log` (настройка в `config_server.json`).
- Вы можете указать в конфигурационных файлах директорию где будут хранится логи, директория будет создана автоматически.
- Поддерживаются различные уровни логгирования - debug, info, warning, critical (Настройка в каждом из конфигурационных файлов)

---

Автор проекта: Александр Морозов, студент IT-школы PROTEI
